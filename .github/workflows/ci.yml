name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Linting job - runs on every push and PR
  lint:
    name: üîç Lint & Code Quality
    runs-on: ubuntu-latest
    
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: |
          bun install --frozen-lockfile
          
      - name: Run ESLint
        run: bun run lint
        continue-on-error: false
        
      - name: Check for TypeScript errors
        run: bun run build --dry-run
        continue-on-error: false

  # Type checking job
  type-check:
    name: üîé TypeScript Type Check
    runs-on: ubuntu-latest
    
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: |
          bun install --frozen-lockfile
          bun run db:generate
          
      - name: Run TypeScript compiler
        run: |
          bunx tsc --noEmit
        continue-on-error: false

  # Build job - ensures application builds successfully
  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    
    needs: [lint, type-check]
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: |
          bun install --frozen-lockfile
          bun run db:generate
          
      - name: Build application
        env:
          NODE_ENV: production
        run: |
          bun run build
        continue-on-error: false
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          retention-days: 7
          compression-level: 9
          
      - name: Check build size
        run: |
          du -sh .next
          du -sh node_modules

  # Security scanning job
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'
        continue-on-error: true
          
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Check for high severity vulnerabilities
        run: |
          if [ -f trivy-results.sarif ]; then
            echo "‚ö†Ô∏è Security scan complete. Review results in Security tab."
          else
            echo "‚úÖ No security issues found."
          fi

  # Dependency audit job
  dependency-audit:
    name: üì¶ Dependency Audit
    runs-on: ubuntu-latest
    
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: Run Bun audit
        run: |
          bun pm audit
        continue-on-error: true
        
      - name: Check for outdated packages
        run: |
          bunx npm-check-updates -u
        continue-on-error: true

  # Database schema validation
  validate-schema:
    name: üóÑÔ∏è Validate Database Schema
    runs-on: ubuntu-latest
    
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: Validate Prisma schema
        run: |
          bunx prisma validate
        continue-on-error: false
        
      - name: Format Prisma schema
        run: |
          bunx prisma format
        continue-on-error: true

  # Success notification
  notify-success:
    name: ‚úÖ CI Success
    runs-on: ubuntu-latest
    needs: [build, security-scan, validate-schema]
    if: success()
    
    steps:
      - name: Check all jobs passed
        run: |
          echo "üéâ All CI jobs passed successfully!"
          echo "Ready to merge!"
          
      - name: Add success comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **CI Pipeline Passed**\n\nAll checks have passed successfully. This PR is ready for review and merge.\n\nüìä [View workflow run](https://github.com/${{ context.repo.owner }}/${{ context.repo.repo }}/actions/runs/${{ github.run_id }})'
            })

  # Failure notification
  notify-failure:
    name: ‚ùå CI Failure
    runs-on: ubuntu-latest
    needs: [build, security-scan, validate-schema]
    if: failure()
    
    steps:
      - name: Check failed jobs
        run: |
          echo "‚ùå One or more CI jobs failed."
          echo "Please review the logs and fix the issues."
          
      - name: Add failure comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **CI Pipeline Failed**\n\nOne or more checks have failed. Please review the logs and fix the issues before merging.\n\nüìä [View workflow run](https://github.com/${{ context.repo.owner }}/${{ context.repo.repo }}/actions/runs/${{ github.run_id }})\n\nüîß Please check:\n- Lint errors\n- TypeScript errors\n- Build failures\n- Security vulnerabilities'
            })
